<!DOCTYPE html>
<html>
<head>
  <title>User Details</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/8.9.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.9.0/firebase-database.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fingerprintjs2/2.1.0/fingerprint2.min.js"></script>
</head>
<body>
  <script>
    // Initialize Firebase
    var firebaseConfig = {
      apiKey: "AIzaSyDVVWLah77CZOVjBqBweWbuPJpnhrHVg_Y",
  authDomain: "portfolio-4bf1c.firebaseapp.com",
  databaseURL: "https://portfolio-4bf1c-default-rtdb.firebaseio.com",
  projectId: "portfolio-4bf1c",
  storageBucket: "portfolio-4bf1c.appspot.com",
  messagingSenderId: "296534124626",
  appId: "1:296534124626:web:133b828c2ecffa7d4f978b",
  measurementId: "G-EQ2J4C5ZGP"
    };
    firebase.initializeApp(firebaseConfig);

// Get user browser location
function getLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(saveLocation);
  } else {
    console.log("Geolocation is not supported by this browser.");
  }
}

// Save user location, browser details, ISP provider, and fingerprint to Firebase database
function saveLocation(position) {
  var latitude = position.coords.latitude;
  var longitude = position.coords.longitude;

  // Load and initialize the fingerprint library
  const fpPromise = import('https://openfpcdn.io/fingerprintjs/v3')
    .then(FingerprintJS => FingerprintJS.load());

  fpPromise
    .then(fp => fp.get())
    .then(result => {
      // This is the visitor identifier (browser fingerprint)
      const visitorId = result.visitorId;
      console.log(visitorId);

      // Get browser details
      const browserDetails = {
        userAgent: navigator.userAgent,
        language: navigator.language,
        vendor: navigator.vendor,
        fingerprint: visitorId
      };

      // Get ISP provider information
      const ipAPI = 'https://ipapi.co/json/';
      axios.get(ipAPI)
        .then(response => {
          const ispProvider = response.data.org;
          console.log(ispProvider);

          // Get current date and time
          const currentDate = new Date().toLocaleDateString();
          const currentTime = new Date().toLocaleTimeString();

          // Create a unique key using fingerprint and current date
          const uniqueKey = visitorId + "_" + currentDate;

          // Save data to Firebase database
          const db = firebase.database();
          const ref = db.ref("userDetails").child(uniqueKey);

          // Check if the data already exists for today
          ref.once("value", snapshot => {
            if (snapshot.exists()) {
              // Data already exists for today, update the exit time and visit count
              const existingData = snapshot.val();
              const visitCount = existingData.visitCount || 0;
              const updateData = {
                exitTime: currentTime,
                visitCount: visitCount + 1
              };
              ref.update(updateData);
              console.log("Data updated for today.");
            } else {
              // Data doesn't exist for today, save the entry details with visit count as 1
              const entryData = {
                latitude: latitude,
                longitude: longitude,
                browserDetails: browserDetails,
                ispProvider: ispProvider,
                entryDate: currentDate,
                entryTime: currentTime,
                visitCount: 1
              };
              ref.set(entryData);
              console.log("User details saved successfully!");
            }
          });
        })
        .catch(error => {
          console.error("Error fetching ISP provider information:", error);
        });
    })
    .catch(error => {
      console.error("Error:", error);
    });
}

// Call the getLocation function when the page loads
window.onload = getLocation;
  </script>
</body>
</html>
